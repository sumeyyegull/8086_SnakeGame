;====================================================================
; PROJE: YILAN OYUNU V36 (SCORE VE GAME OVER DUZELTMESI)
;====================================================================
; DONANIM AYNI (V35 ILE BIREBIR):
; RS (Pin 4) -> PC4
; RW (Pin 5) -> GND
; E  (Pin 6) -> PC5
; HIZ        -> 250
; YONLER     -> PC0=Sol, PC1=Sag, PC2=Asagi, PC3=Yukari
;====================================================================

PORT_A       EQU 0F7F0H
PORT_B       EQU 0F7F2H
PORT_C       EQU 0F7F4H
KONTROL      EQU 0F7F6H

VERI_SEGMENTI SEGMENT
YILAN_X      DB 64 DUP(0)
YILAN_Y      DB 64 DUP(0)
MEVCUT_BOY   DB 3
SUANKI_YON   DB 0

SABIT_HIZ    DW 250
ZAMAN_SAYACI DW 0

HEDEF_YEM_X  DB 4
HEDEF_YEM_Y  DB 2
YANIP_SONME_SAYAC DB 0
GORUNTU_RAM  DB 8 DUP(0)
LCD_TEMP     DB 0
VERI_SEGMENTI ENDS

KOD_SEGMENTI SEGMENT
ASSUME CS:KOD_SEGMENTI, DS:VERI_SEGMENTI

BASLANGIC:
MOV AX, VERI_SEGMENTI
MOV DS, AX

; 8255 Kurulumu
MOV DX, KONTROL
MOV AL, 81H
OUT DX, AL

; LCD Baslat
CALL LCD_INIT
CALL SKOR_GUNCELLE

; Yilan Baslangic
MOV MEVCUT_BOY, 3
MOV SUANKI_YON, 0

MOV YILAN_X[0], 2
MOV YILAN_Y[0], 3
MOV YILAN_X[1], 1
MOV YILAN_Y[1], 3
MOV YILAN_X[2], 0
MOV YILAN_Y[2], 3

ANA_DONGU:
CALL EKRAN_CIZIMI_HAZIRLA
MOV AX, SABIT_HIZ
MOV ZAMAN_SAYACI, AX

BEKLEME_LOOP:
CALL MATRISI_SUR
CALL YON_KONTROL_ET
DEC ZAMAN_SAYACI
JNZ BEKLEME_LOOP
JMP HAREKET_ISLEMLERI

;-----------------------------------------------------------------------
; HAREKET
;-----------------------------------------------------------------------
HAREKET_ISLEMLERI:
MOV CL, MEVCUT_BOY
DEC CL
MOV CH, 0
MOV SI, CX
KAYDIRMA:
MOV AL, YILAN_X[SI-1]
MOV YILAN_X[SI], AL
MOV AL, YILAN_Y[SI-1]
MOV YILAN_Y[SI], AL
DEC SI
JNZ KAYDIRMA

CMP SUANKI_YON, 0
JE GIT_SAG
CMP SUANKI_YON, 1
JE GIT_SOL
CMP SUANKI_YON, 2
JE GIT_ASAGI
CMP SUANKI_YON, 3
JE GIT_YUKARI

GIT_SAG:
INC YILAN_X[0]
JMP DUVAR_KONTROL
GIT_SOL:
DEC YILAN_X[0]
JMP DUVAR_KONTROL
GIT_ASAGI:
INC YILAN_Y[0]
JMP DUVAR_KONTROL
GIT_YUKARI:
DEC YILAN_Y[0]
JMP DUVAR_KONTROL

DUVAR_KONTROL:
MOV AL, YILAN_X[0]
AND AL, 07H
MOV YILAN_X[0], AL
MOV AL, YILAN_Y[0]
AND AL, 07H
MOV YILAN_Y[0], AL

; Carpisma
MOV CL, MEVCUT_BOY
DEC CL
MOV CH, 0
MOV SI, 1
CARPISMA_TESTI:
MOV AL, YILAN_X[0]
CMP AL, YILAN_X[SI]
JNE TEST_DEVAM
MOV AL, YILAN_Y[0]
CMP AL, YILAN_Y[SI]
JE OYUN_BITTI_GIRIS
TEST_DEVAM:
INC SI
LOOP CARPISMA_TESTI

; Yem
MOV AL, YILAN_X[0]
CMP AL, HEDEF_YEM_X
JNE ANA_DONGU
MOV AL, YILAN_Y[0]
CMP AL, HEDEF_YEM_Y
JNE ANA_DONGU

INC MEVCUT_BOY
CALL SKOR_GUNCELLE

MOV AL, HEDEF_YEM_X
ADD AL, 3
AND AL, 07H
MOV HEDEF_YEM_X, AL
MOV AL, HEDEF_YEM_Y
ADD AL, 5
AND AL, 07H
MOV HEDEF_YEM_Y, AL
JMP ANA_DONGU

;-----------------------------------------------------------------------
; TUS OKUMA
;-----------------------------------------------------------------------
YON_KONTROL_ET PROC
PUSH AX
PUSH DX
MOV DX, PORT_C
IN AL, DX
AND AL, 0FH
CMP AL, 0FH
JE YON_CIKIS

TEST AL, 01H       ; SOL
JZ AYARLA_SOL
TEST AL, 02H       ; SAG
JZ AYARLA_SAG
TEST AL, 04H       ; ASAGI
JZ AYARLA_ASAGI
TEST AL, 08H       ; YUKARI
JZ AYARLA_YUKARI
JMP YON_CIKIS

AYARLA_SOL:
CMP SUANKI_YON, 0
JE YON_CIKIS
MOV SUANKI_YON, 1
JMP YON_CIKIS

AYARLA_SAG:
CMP SUANKI_YON, 1
JE YON_CIKIS
MOV SUANKI_YON, 0
JMP YON_CIKIS

AYARLA_ASAGI:
CMP SUANKI_YON, 3
JE YON_CIKIS
MOV SUANKI_YON, 2
JMP YON_CIKIS

AYARLA_YUKARI:
CMP SUANKI_YON, 2
JE YON_CIKIS
MOV SUANKI_YON, 3
JMP YON_CIKIS

YON_CIKIS:
POP DX
POP AX
RET
YON_KONTROL_ET ENDP

;-----------------------------------------------------------------------
; OYUN BITIS
;-----------------------------------------------------------------------
OYUN_BITTI_GIRIS:
CALL GAME_OVER_YAZ

FLASOR_LOOP:
MOV CX, 8
MOV SI, 0
DOL: MOV GORUNTU_RAM[SI], 0FFH
INC SI
LOOP DOL
MOV CX, 20
DOL_WAIT:
PUSH CX
CALL MATRISI_SUR
POP CX
LOOP DOL_WAIT
MOV CX, 8
MOV SI, 0
BOS: MOV GORUNTU_RAM[SI], 00H
INC SI
LOOP BOS
MOV CX, 20
BOS_WAIT:
PUSH CX
CALL MATRISI_SUR
POP CX
LOOP BOS_WAIT
JMP FLASOR_LOOP

;-----------------------------------------------------------------------
; EKRAN CIZIM
;-----------------------------------------------------------------------
EKRAN_CIZIMI_HAZIRLA PROC
PUSH AX
PUSH BX
PUSH CX
PUSH SI
PUSH DI
MOV CX, 8
MOV SI, 0
TEMIZLE_LP: MOV GORUNTU_RAM[SI], 0
INC SI
LOOP TEMIZLE_LP
INC YANIP_SONME_SAYAC
TEST YANIP_SONME_SAYAC, 1
JZ YILAN_CIZ_L
MOV BL, HEDEF_YEM_X
MOV BH, HEDEF_YEM_Y
MOV SI, 0
MOV AL, BH
CBW
MOV SI, AX
MOV CL, BL
MOV AL, 1
SHL AL, CL
OR GORUNTU_RAM[SI], AL
YILAN_CIZ_L:
MOV CL, MEVCUT_BOY
MOV CH, 0
MOV DI, 0
YILAN_LOOP_L:
MOV AL, YILAN_Y[DI]
CBW
MOV SI, AX
MOV DL, YILAN_X[DI]
MOV AL, 1
PUSH CX
MOV CL, DL
SHL AL, CL
POP CX
OR GORUNTU_RAM[SI], AL
INC DI
LOOP YILAN_LOOP_L
POP DI
POP SI
POP CX
POP BX
POP AX
RET
EKRAN_CIZIMI_HAZIRLA ENDP

;-----------------------------------------------------------------------
; MATRIS SURME
;-----------------------------------------------------------------------
MATRISI_SUR PROC
PUSH AX
PUSH BX
PUSH CX
PUSH SI
PUSH DX

; LCD pinlerini SIFIRLA
MOV DX, PORT_C
MOV AL, 0
OUT DX, AL

MOV CX, 8
MOV SI, 0
MOV BH, 01H
TARAMA_L:
MOV DX, PORT_A
MOV AL, BH
OUT DX, AL

MOV DX, PORT_B
MOV AL, GORUNTU_RAM[SI]
NOT AL
OUT DX, AL

PUSH CX
MOV CX, 50
BEKLE_L: NOP
LOOP BEKLE_L
POP CX

MOV DX, PORT_A
MOV AL, 0
OUT DX, AL

ROL BH, 1
INC SI
LOOP TARAMA_L

POP DX
POP SI
POP CX
POP BX
POP AX
RET
MATRISI_SUR ENDP

;=======================================================================
; LCD FONKSIYONLARI
;=======================================================================
GECIKME_LCD PROC NEAR
PUSH CX
MOV CX, 500
DLY_LCD: NOP
LOOP DLY_LCD
POP CX
RET
GECIKME_LCD ENDP

; Komut (RS=0)
LCD_KOMUT PROC NEAR
PUSH DX
PUSH AX
MOV LCD_TEMP, AL

; 1. Veriyi Port A'ya yaz
MOV DX, PORT_A
MOV AL, LCD_TEMP
OUT DX, AL

; 2. Sinyal: E=1 (PC5), RS=0 (PC4) -> 0010 0000b = 20H
MOV DX, PORT_C
MOV AL, 20H
OUT DX, AL
NOP
NOP

; 3. Sinyal: E=0 (PC5), RS=0 -> 00H
MOV AL, 00H
OUT DX, AL

CALL GECIKME_LCD
POP AX
POP DX
RET
LCD_KOMUT ENDP

; Veri (RS=1)
LCD_VERI PROC NEAR
PUSH DX
PUSH AX
MOV LCD_TEMP, AL

; 1. Veriyi Port A'ya yaz
MOV DX, PORT_A
MOV AL, LCD_TEMP
OUT DX, AL

; 2. Sinyal: E=1 (PC5), RS=1 (PC4) -> 0011 0000b = 30H
MOV DX, PORT_C
MOV AL, 30H
OUT DX, AL
NOP
NOP

; 3. Sinyal: E=0 (PC5), RS=1 (PC4) -> 0001 0000b = 10H
MOV AL, 10H
OUT DX, AL

CALL GECIKME_LCD
POP AX
POP DX
RET
LCD_VERI ENDP

LCD_INIT PROC NEAR
PUSH AX
PUSH DX
MOV AL, 38H
CALL LCD_KOMUT
MOV AL, 0CH
CALL LCD_KOMUT
MOV AL, 01H
CALL LCD_KOMUT
MOV AL, 06H
CALL LCD_KOMUT
POP DX
POP AX
RET
LCD_INIT ENDP

SKOR_GUNCELLE PROC NEAR
PUSH AX
MOV AL, 80H
CALL LCD_KOMUT

; "SCORE: " YAZIYORUZ
MOV AL, 'S'
CALL LCD_VERI
MOV AL, 'C'
CALL LCD_VERI
MOV AL, 'O'
CALL LCD_VERI
MOV AL, 'R'
CALL LCD_VERI
MOV AL, 'E'
CALL LCD_VERI
MOV AL, ':'
CALL LCD_VERI
MOV AL, ' '
CALL LCD_VERI

MOV AL, MEVCUT_BOY
ADD AL, 30H
CALL LCD_VERI
POP AX
RET
SKOR_GUNCELLE ENDP

GAME_OVER_YAZ PROC NEAR
MOV AL, 01H
CALL LCD_KOMUT

; "GAME OVER" HARF HARF EKLENDI
MOV AL, 'G'
CALL LCD_VERI
MOV AL, 'A'
CALL LCD_VERI
MOV AL, 'M'
CALL LCD_VERI
MOV AL, 'E'
CALL LCD_VERI
MOV AL, ' '
CALL LCD_VERI
MOV AL, 'O'
CALL LCD_VERI
MOV AL, 'V'
CALL LCD_VERI
MOV AL, 'E'
CALL LCD_VERI
MOV AL, 'R'
CALL LCD_VERI
RET
GAME_OVER_YAZ ENDP

KOD_SEGMENTI ENDS
END BASLANGIC

