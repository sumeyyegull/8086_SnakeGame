;====================================================================
; PROJE: OTOMATÝK YILAN OYUNU V2.1 (FIXED)
;====================================================================

RAM_SEGMENTI SEGMENT AT 0000H
ORG 0000H
YILAN_X      DB 64 DUP(?)
YILAN_Y      DB 64 DUP(?)
MEVCUT_BOY   DB ?
SUANKI_YON   DB ?
SABIT_HIZ    DW ?
ZAMAN_SAYACI DW ?
HEDEF_YEM_X  DB ?
HEDEF_YEM_Y  DB ?
YANIP_SONME_SAYAC DB ?
GORUNTU_RAM  DB 8 DUP(?)
DB 256 DUP(?)
STACK_TOP LABEL BYTE
RAM_SEGMENTI ENDS

KOD_SEGMENTI SEGMENT
ASSUME CS:KOD_SEGMENTI, DS:RAM_SEGMENTI, SS:RAM_SEGMENTI
ORG 0000H

;=======================================================================
; PROSEDÜRLER (HATA VERMEMESÝ ÝÇÝN EN BAÞA ALINDI)
;=======================================================================

;--- TUÞ OKUMA PROSEDÜRÜ ---
YON_KONTROL_ET PROC NEAR
PUSH AX
IN AL, 04H             ; Port C Oku
AND AL, 0FH            ; Sadece ilk 4 biti al
CMP AL, 0FH
JE YON_RET             ; Basýlý deðilse (Pull-up sebebiyle F gelir) dön

TEST AL, 01H
JZ SET_SAG
TEST AL, 02H
JZ SET_SOL
TEST AL, 04H
JZ SET_ASAGI
TEST AL, 08H
JZ SET_YUKARI
JMP YON_RET

SET_SAG:   MOV SUANKI_YON, 0
JMP YON_RET
SET_SOL:   MOV SUANKI_YON, 1
JMP YON_RET
SET_ASAGI: MOV SUANKI_YON, 2
JMP YON_RET
SET_YUKARI:MOV SUANKI_YON, 3
YON_RET:
POP AX
RET
YON_KONTROL_ET ENDP

;--- MATRÝS SÜRME PROSEDÜRÜ ---
MATRISI_SUR PROC NEAR
PUSH AX
PUSH BX
PUSH CX
PUSH SI
MOV CX, 8
MOV SI, 0
MOV BH, 01H
SCAN_L:
MOV AL, BH
OUT 00H, AL            ; Satýr
MOV AL, GORUNTU_RAM[SI]
NOT AL                 ; Sütun (Active Low)
OUT 02H, AL

PUSH CX
MOV CX, 100            ; Gecikme
WAIT_L: NOP
LOOP WAIT_L
POP CX

MOV AL, 0
OUT 00H, AL            ; Temizle
ROL BH, 1
INC SI
LOOP SCAN_L
POP SI
POP CX
POP BX
POP AX
RET
MATRISI_SUR ENDP

;--- EKRAN ÇÝZÝM PROSEDÜRÜ ---
EKRAN_CIZIMI_HAZIRLA PROC NEAR
PUSH AX
PUSH BX
PUSH CX
PUSH SI
PUSH DI

; RAM Temizle
MOV CX, 8
MOV SI, 0
CLR_LOOP:
MOV GORUNTU_RAM[SI], 0
INC SI
LOOP CLR_LOOP

; Yem Çiz
INC YANIP_SONME_SAYAC
TEST YANIP_SONME_SAYAC, 1
JZ DRAW_SNAKE

MOV BL, HEDEF_YEM_X
MOV BH, HEDEF_YEM_Y
MOV SI, 0
MOV AL, BH
CBW
MOV SI, AX
MOV CL, BL
MOV AL, 1
SHL AL, CL
OR GORUNTU_RAM[SI], AL

DRAW_SNAKE:
MOV CL, MEVCUT_BOY
MOV CH, 0
MOV DI, 0
SNAKE_LOOP:
MOV AL, YILAN_Y[DI]
CBW
MOV SI, AX
MOV DL, YILAN_X[DI]
MOV AL, 1
PUSH CX
MOV CL, DL
SHL AL, CL
POP CX
OR GORUNTU_RAM[SI], AL
INC DI
LOOP SNAKE_LOOP

POP DI
POP SI
POP CX
POP BX
POP AX
RET
EKRAN_CIZIMI_HAZIRLA ENDP

;=======================================================================
; ANA PROGRAM BAÞLANGICI
;=======================================================================
BASLANGIC:
CLI

;--- SEGMENT AYARLARI ---
MOV AX, 0000H
MOV DS, AX
MOV SS, AX
MOV SP, OFFSET STACK_TOP

;--- 8255 AYARI ---
MOV AL, 89H
OUT 06H, AL

;--- ÝLK DEÐERLER ---
MOV MEVCUT_BOY, 3
MOV SUANKI_YON, 0
MOV SABIT_HIZ, 90
MOV HEDEF_YEM_X, 4
MOV HEDEF_YEM_Y, 2
MOV YANIP_SONME_SAYAC, 0

MOV YILAN_X[0], 2
MOV YILAN_Y[0], 3
MOV YILAN_X[1], 1
MOV YILAN_Y[1], 3
MOV YILAN_X[2], 0
MOV YILAN_Y[2], 3

ANA_DONGU:
CALL EKRAN_CIZIMI_HAZIRLA

MOV AX, SABIT_HIZ
MOV ZAMAN_SAYACI, AX

BEKLEME_LOOP:
CALL MATRISI_SUR
CALL YON_KONTROL_ET    ; ARTIK HATA VERMEZ!

DEC ZAMAN_SAYACI
JNZ BEKLEME_LOOP

JMP HAREKET_ISLEMLERI

;--- HAREKET MANTIÐI ---
HAREKET_ISLEMLERI:
; Gövde Kaydýr
MOV CL, MEVCUT_BOY
DEC CL
MOV CH, 0
MOV SI, CX
KAYDIRMA:
MOV AL, YILAN_X[SI-1]
MOV YILAN_X[SI], AL
MOV AL, YILAN_Y[SI-1]
MOV YILAN_Y[SI], AL
DEC SI
JNZ KAYDIRMA

; Baþ Hareket
CMP SUANKI_YON, 0
JE GIT_SAG
CMP SUANKI_YON, 1
JE GIT_SOL
CMP SUANKI_YON, 2
JE GIT_ASAGI
CMP SUANKI_YON, 3
JE GIT_YUKARI
JMP DUVAR_KONTROL

GIT_SAG:  INC YILAN_X[0]
JMP DUVAR_KONTROL
GIT_SOL:  DEC YILAN_X[0]
JMP DUVAR_KONTROL
GIT_ASAGI:INC YILAN_Y[0]
JMP DUVAR_KONTROL
GIT_YUKARI:DEC YILAN_Y[0]
JMP DUVAR_KONTROL

DUVAR_KONTROL:
MOV AL, YILAN_X[0]
AND AL, 07H
MOV YILAN_X[0], AL
MOV AL, YILAN_Y[0]
AND AL, 07H
MOV YILAN_Y[0], AL

; Çarpýþma
MOV CL, MEVCUT_BOY
DEC CL
MOV CH, 0
MOV SI, 1
CARPISMA_TESTI:
MOV AL, YILAN_X[0]
CMP AL, YILAN_X[SI]
JNE TEST_DEVAM
MOV AL, YILAN_Y[0]
CMP AL, YILAN_Y[SI]
JE OYUN_BITTI_GIRIS
TEST_DEVAM:
INC SI
LOOP CARPISMA_TESTI

; Yem Kontrol
MOV AL, YILAN_X[0]
CMP AL, HEDEF_YEM_X
JNE ANA_DONGU
MOV AL, YILAN_Y[0]
CMP AL, HEDEF_YEM_Y
JNE ANA_DONGU

; Yem Yendi
INC MEVCUT_BOY

MOV AL, HEDEF_YEM_X
ADD AL, 5
AND AL, 07H
MOV HEDEF_YEM_X, AL
MOV AL, HEDEF_YEM_Y
ADD AL, 3
AND AL, 07H
MOV HEDEF_YEM_Y, AL

JMP ANA_DONGU

;--- OYUN BÝTÝÞ ---
OYUN_BITTI_GIRIS:
MOV CX, 8
MOV SI, 0
FULL_ON:
MOV GORUNTU_RAM[SI], 0FFH
INC SI
LOOP FULL_ON
CALL MATRISI_SUR
CALL MATRISI_SUR

MOV CX, 8
MOV SI, 0
FULL_OFF:
MOV GORUNTU_RAM[SI], 00H
INC SI
LOOP FULL_OFF
CALL MATRISI_SUR
CALL MATRISI_SUR
JMP OYUN_BITTI_GIRIS

KOD_SEGMENTI ENDS
END BASLANGIC

